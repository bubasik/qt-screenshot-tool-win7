name: Build Qt Screenshot Tool

on:
  push:
    branches: [ main ]
  pull_request:
  workflow_dispatch:

jobs:
  build-windows:
    runs-on: windows-2022
    
    strategy:
      matrix:
        arch: 
          - name: win64
            qt_arch: win64_mingw73
            mingw_dir: mingw730_64
          - name: win32
            qt_arch: win32_mingw73
            mingw_dir: mingw730_32
    
    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4

      - name: ‚öôÔ∏è Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: üì¶ Install Qt 5.12.12 via aqtinstall
        run: |
          pip install aqtinstall==3.1.13
          aqt install-qt windows desktop 5.12.12 ${{ matrix.arch.qt_arch }} -O C:\Qt
          aqt install-tool windows desktop tools_mingw730 -O C:\Qt
        shell: pwsh

      - name: üîß Add Qt and MinGW to PATH
        run: |
          # –ü—É—Ç–∏ –∫ Qt –∏ –∫–æ–º–ø–∏–ª—è—Ç–æ—Ä—É
          $qtVer = "5.12.12"
          $qtArch = "${{ matrix.arch.qt_arch }}"
          $mingwDir = "${{ matrix.arch.mingw_dir }}"
          
          $qtBinPath = "C:\Qt\$qtVer\$qtArch\bin"
          $mingwBinPath = "C:\Qt\Tools\$mingwDir\bin"
          
          # –î–æ–±–∞–≤–ª—è–µ–º –≤ PATH –¥–ª—è —Ç–µ–∫—É—â–µ–π —Å–µ—Å—Å–∏–∏
          $env:Path = "$qtBinPath;$mingwBinPath;" + $env:Path
          
          # –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–ª—è –ø–æ—Å–ª–µ–¥—É—é—â–∏—Ö —à–∞–≥–æ–≤ —á–µ—Ä–µ–∑ $env:GITHUB_PATH
          echo "$qtBinPath" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
          echo "$mingwBinPath" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
          
          # –û—Ç–ª–∞–¥–∫–∞: –ø—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –≤—Å—ë –Ω–∞ –º–µ—Å—Ç–µ
          Write-Host "Qt bin path: $qtBinPath"
          Write-Host "MinGW bin path: $mingwBinPath"
          Get-ChildItem -Path $qtBinPath -Filter qmake.exe -ErrorAction SilentlyContinue
          Get-ChildItem -Path $mingwBinPath -Filter mingw32-make.exe -ErrorAction SilentlyContinue
        shell: pwsh

      - name: üîç Verify installation
        run: |
          qmake --version
          mingw32-make -v
          where qmake
          where mingw32-make
        shell: cmd

      - name: üõ†Ô∏è Build project
        run: |
          qmake ScreenshotTool.pro "CONFIG+=release"
          mingw32-make -j4
        shell: cmd

      - name: üì¶ Deploy dependencies
        run: |
          windeployqt --release --qmldir . release\ScreenshotTool.exe
        working-directory: release
        shell: cmd

      - name: üíæ Package artifacts
        run: |
          $archName = "${{ matrix.arch.name }}"
          $zipName = "ScreenshotTool-${archName}-qt5.12.12.zip"
          Compress-Archive -Path "release\*" -DestinationPath "..\$zipName"
          echo "ARTIFACT_NAME=$zipName" | Out-File -FilePath $env:GITHUB_ENV -Append
        working-directory: release
        shell: pwsh

      - name: üöÄ Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.ARTIFACT_NAME }}
          path: ${{ env.ARTIFACT_NAME }}
          retention-days: 30
