name: Build Qt Screenshot Tool for Windows 7

on:
  push:
    branches: [ main ]
  pull_request:
  workflow_dispatch:

jobs:
  build-win32:
    runs-on: windows-2022

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: âš™ï¸ Setup Qt 5.12.12 (32-bit)
        uses: jurplel/install-qt-action@v4
        with:
          version: '5.12.12'
          arch: 'win32_mingw73'
          cache: true
          cache-key-prefix: qt-win32-mingw73-5.12.12
          set-env: true  # â† ĞšĞ Ğ˜Ğ¢Ğ˜Ğ§Ğ•Ğ¡ĞšĞ˜ Ğ’ĞĞ–ĞĞ: Ğ½Ğ°ÑÑ‚Ñ€Ğ°Ğ¸Ğ²Ğ°ĞµÑ‚ Ğ¾ĞºÑ€ÑƒĞ¶ĞµĞ½Ğ¸Ğµ

      - name: ğŸ”§ Fix PATH: prioritize 32-bit toolchain (PowerShell)
        shell: pwsh
        run: |
          # ĞŸÑ€Ğ°Ğ²Ğ¸Ğ»ÑŒĞ½Ñ‹Ğµ Ğ¿ÑƒÑ‚Ğ¸ Ğ´Ğ»Ñ Qt 5.12.12 win32_mingw73
          $qtBin = "C:\Qt\5.12.12\mingw73_32\bin"
          $mingwBin = "C:\Qt\Tools\mingw730_32\bin"
          
          # Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ÑĞµĞ¼ Ğ¿ÑƒÑ‚Ğ¸ Ğ’ ĞĞĞ§ĞĞ›Ğ %GITHUB_PATH% (Ğ³Ğ°Ñ€Ğ°Ğ½Ñ‚Ğ¸Ñ€ÑƒĞµÑ‚ Ğ¿Ñ€Ğ¸Ğ¾Ñ€Ğ¸Ñ‚ĞµÑ‚)
          "$qtBin" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
          "$mingwBin" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
          
          Write-Host "âœ… Added to PATH (priority order):"
          Write-Host "   1. $qtBin"
          Write-Host "   2. $mingwBin"

      - name: ğŸ” Verify 32-bit toolchain
        shell: pwsh
        run: |
          Write-Host "=== Checking qmake ==="
          Get-Command qmake -ErrorAction Stop | Select-Object Name, Source
          
          Write-Host "`n=== Checking g++ ==="
          Get-Command g++ -ErrorAction Stop | Select-Object Name, Source
          
          Write-Host "`n=== Checking architecture (MUST be i686) ==="
          $arch = g++ -dumpmachine 2>&1
          Write-Host "Architecture: $arch"
          
          if ($arch -like "*x86_64*") {
            Write-Error "âŒ FATAL: 64-bit compiler detected! Aborting build."
            exit 1
          }
          Write-Host "âœ… OK: 32-bit toolchain confirmed (i686)"

      - name: ğŸ› ï¸ Build project (Release)
        run: |
          qmake ScreenshotTool.pro "CONFIG+=release"
          mingw32-make -j4
        shell: cmd

      - name: ğŸ“¦ Deploy Qt dependencies
        run: |
          windeployqt --release release\ScreenshotTool.exe
        working-directory: release
        shell: cmd

      - name: ğŸ’¾ Package for Windows 7
        run: |
          Compress-Archive -Path release\* -DestinationPath ScreenshotTool-win32-qt5.12.12.zip -Force
        shell: pwsh

      - name: ğŸš€ Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ScreenshotTool-win32-qt5.12.12
          path: ScreenshotTool-win32-qt5.12.12.zip
          retention-days: 30

      - name: âœ… Success message
        if: success()
        run: |
          echo.
          echo ========================================
          echo  âœ… BUILD SUCCESSFUL!
          echo  ğŸ“¦ Artifact: ScreenshotTool-win32-qt5.12.12.zip
          echo  ğŸ’» Works on Windows 7 SP1 (32/64-bit)
          echo ========================================
        shell: cmd
