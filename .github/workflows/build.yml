name: Build Qt Screenshot Tool (aqt)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-2022
    
    strategy:
      matrix:
        arch: [ win64_mingw73, win32_mingw73 ]
    
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: âš™ï¸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: ğŸ“¦ Install Qt 5.12.12 via aqt
        run: |
          pip install aqtinstall==3.1.13
          aqt install-qt windows desktop 5.12.12 ${{ matrix.arch }} -O C:\Qt
        shell: pwsh

      - name: ğŸ”§ Add Qt to PATH
        run: |
          $qtVer = "5.12.12"
          $arch = "${{ matrix.arch }}"
          $qtPath = "C:\Qt\$qtVer\$arch\bin"
          echo "$qtPath" | Out-File -FilePath $env:GITHUB_PATH -Append
          echo "Qt path: $qtPath"
        shell: pwsh

      - name: ğŸ› ï¸ Build
        run: |
          qmake ScreenshotTool.pro "CONFIG+=release"
          mingw32-make -j4
        shell: cmd

      - name: ğŸ“¦ Deploy
        run: |
          windeployqt --release release\ScreenshotTool.exe
        working-directory: release
        shell: cmd

      - name: ğŸ’¾ Package
        run: |
          $bits = if ("${{ matrix.arch }}" -like "win64*") { "win64" } else { "win32" }
          Compress-Archive -Path "release\*" -DestinationPath "ScreenshotTool-${bits}-qt5.12.12.zip"
        shell: pwsh

      - name: ğŸš€ Upload
        uses: actions/upload-artifact@v4
        with:
          name: ScreenshotTool-${{ matrix.arch }}
          path: ScreenshotTool-*.zip
