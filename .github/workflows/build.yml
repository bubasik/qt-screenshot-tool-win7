name: Build Qt Screenshot Tool (64-bit)

on:
  push:
    branches: [ main ]
  pull_request:
  workflow_dispatch:

jobs:
  build-win64:
    runs-on: windows-2022

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: âš™ï¸ Setup Qt 5.12.12 (64-bit, MinGW)
        uses: jurplel/install-qt-action@v4
        with:
          version: '5.12.12'
          arch: 'win64_mingw73'  # â† 64-Ğ±Ğ¸Ñ‚Ğ½Ğ°Ñ Ğ°Ñ€Ñ…Ğ¸Ñ‚ĞµĞºÑ‚ÑƒÑ€Ğ°
          cache: true
          cache-key-prefix: qt-win64-mingw73-5.12.12
          set-env: true  # ĞĞ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸ Ğ½Ğ°ÑÑ‚Ñ€Ğ°Ğ¸Ğ²Ğ°ĞµÑ‚ PATH

      - name: ğŸ” Verify 64-bit toolchain
        shell: pwsh
        run: |
          Write-Host "=== Checking qmake ==="
          Get-Command qmake -ErrorAction Stop | Select-Object Name, Source
          
          Write-Host "`n=== Checking g++ ==="
          Get-Command g++ -ErrorAction Stop | Select-Object Name, Source
          
          Write-Host "`n=== Checking architecture (MUST be x86_64) ==="
          $arch = g++ -dumpmachine 2>&1
          Write-Host "Architecture: $arch"
          
          if ($arch -notlike "*x86_64*") {
            Write-Error "âŒ FATAL: Not a 64-bit compiler! Aborting build."
            exit 1
          }
          Write-Host "âœ… OK: 64-bit toolchain confirmed"

      - name: ğŸ› ï¸ Build project (Release)
        run: |
          qmake ScreenshotTool.pro "CONFIG+=release"
          mingw32-make -j4
        shell: cmd

      - name: ğŸ“¦ Deploy Qt dependencies
        run: |
          windeployqt --release release\ScreenshotTool.exe
        working-directory: release
        shell: cmd

      - name: ğŸ’¾ Package for Windows
        run: |
          Compress-Archive -Path release\* -DestinationPath ScreenshotTool-win64-qt5.12.12.zip -Force
        shell: pwsh

      - name: ğŸš€ Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ScreenshotTool-win64-qt5.12.12
          path: ScreenshotTool-win64-qt5.12.12.zip
          retention-days: 30

      - name: âœ… Success message
        if: success()
        run: |
          echo.
          echo ========================================
          echo  âœ… BUILD SUCCESSFUL!
          echo  ğŸ“¦ Artifact: ScreenshotTool-win64-qt5.12.12.zip
          echo  ğŸ’» Works on Windows 7+ (64-bit only)
          echo ========================================
        shell: cmd
