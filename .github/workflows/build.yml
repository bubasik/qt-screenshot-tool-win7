name: Build Qt Screenshot Tool

on:
  push:
    branches: [ main ]
  pull_request:
  workflow_dispatch:

jobs:
  build-windows:
    runs-on: windows-2022
    
    strategy:
      matrix:
        # Qt 5.12.12 –¥–æ—Å—Ç—É–ø–µ–Ω —Ç–æ–ª—å–∫–æ —Å –∫–æ–º–ø–∏–ª—è—Ç–æ—Ä–æ–º MinGW 7.3
        qt_arch: [ win64_mingw73, win32_mingw73 ]
    
    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4

      - name: ‚öôÔ∏è Setup Qt 5.12.12
        uses: jurplel/install-qt-action@v4
        with:
          version: '5.12.12'
          arch: ${{ matrix.qt_arch }}
          modules: 'qttools'  # –î–ª—è windeployqt
          cache: true
          cache-key-prefix: qt-${{ matrix.qt_arch }}

      - name: üîç Debug: –ü—Ä–æ–≤–µ—Ä–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏
        run: |
          echo "Qt dir: $Env:Qt5_Dir"
          qmake --version
          windeployqt --version

      - name: üõ†Ô∏è Build project
        run: |
          qmake ScreenshotTool.pro "CONFIG+=release"
          mingw32-make -j4
        shell: cmd

      - name: üì¶ Deploy dependencies
        run: |
          windeployqt --release --qmldir . release\ScreenshotTool.exe
        working-directory: release
        shell: cmd

      - name: üíæ Package artifacts
        run: |
          $arch = "${{ matrix.qt_arch }}"
          # –ò–∑–≤–ª–µ–∫–∞–µ–º –±–∏—Ç–Ω–æ—Å—Ç—å –∏–∑ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã (win64_mingw73 ‚Üí win64)
          $bits = if ($arch -like "win64*") { "win64" } else { "win32" }
          $zipName = "ScreenshotTool-${bits}-qt5.12.12.zip"
          Compress-Archive -Path "release\*" -DestinationPath "..\$zipName"
          echo "ARTIFACT_NAME=$zipName" | Out-File -FilePath $env:GITHUB_ENV -Append
        working-directory: release
        shell: pwsh

      - name: üöÄ Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.ARTIFACT_NAME }}
          path: ${{ env.ARTIFACT_NAME }}
          retention-days: 30
