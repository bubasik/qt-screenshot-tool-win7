name: Build Qt Screenshot Tool for Windows 7

on:
  push:
    branches: [ main ]
  pull_request:
  workflow_dispatch:

jobs:
  build-win32:
    runs-on: windows-2022
    defaults:
      run:
        shell: cmd

    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4

      - name: ‚öôÔ∏è Setup Qt 5.12.12 (32-bit) with isolated env
        uses: jurplel/install-qt-action@v4
        with:
          version: '5.12.12'
          arch: 'win32_mingw73'
          cache: true
          cache-key-prefix: qt-win32-mingw73-5.12.12
          set-env: true  # ‚Üê –ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û: –∏–∑–æ–ª–∏—Ä—É–µ—Ç –æ–∫—Ä—É–∂–µ–Ω–∏–µ

      - name: üîß Purge 64-bit MinGW from PATH (critical fix)
        run: |
          @echo off
          echo Original PATH:
          echo %PATH%
          echo.
          
          rem –£–¥–∞–ª—è–µ–º –í–°–ï 64-–±–∏—Ç–Ω—ã–µ –∫–æ–º–ø–∏–ª—è—Ç–æ—Ä—ã –∏–∑ PATH
          set "NEW_PATH="
          for %%i in (%PATH:;= %) do (
            echo Checking: %%i | findstr /i /v "mingw64 x86_64 64-bit" >nul && (
              if defined NEW_PATH (
                set "NEW_PATH=!NEW_PATH!;%%i"
              ) else (
                set "NEW_PATH=%%i"
              )
            )
          )
          
          echo.
          echo Cleaned PATH (without 64-bit compilers):
          echo !NEW_PATH!
          echo.
          
          rem –î–æ–±–∞–≤–ª—è–µ–º 32-–±–∏—Ç–Ω—ã–π —Ç—É–ª—á–µ–π–Ω –∏–∑ Qt –í –ù–ê–ß–ê–õ–û
          set "QT_BIN=C:\Qt\5.12.12\mingw73_32\bin"
          set "MINGW_BIN=C:\Qt\Tools\mingw730_32\bin"
          
          set "PATH=%QT_BIN%;%MINGW_BIN%;!NEW_PATH!"
          echo %PATH% > %GITHUB_PATH%
          
          echo.
          echo Final PATH configured for 32-bit compilation

      - name: üîç Verify 32-bit toolchain (MUST show i686)
        run: |
          @echo off
          echo === Checking qmake ===
          where qmake
          qmake --version
          echo.
          
          echo === Checking g++ ===
          where g++
          g++ --version
          echo.
          
          echo === Checking architecture (MUST be i686) ===
          g++ -dumpmachine
          echo.
          
          echo === Checking PATH ===
          path
          echo.
          
          rem –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞: –µ—Å–ª–∏ –≤–∏–¥–∏–º x86_64 ‚Äî –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–±–æ—Ä–∫—É
          g++ -dumpmachine | findstr /i "x86_64" && (
            echo ERROR: 64-bit compiler detected! Aborting build.
            exit /b 1
          ) || (
            echo OK: 32-bit toolchain confirmed (i686)
          )

      - name: üõ†Ô∏è Build project (Release) ‚Äî ignoring Qt warnings
        run: |
          @echo off
          echo Building with qmake...
          qmake ScreenshotTool.pro "CONFIG+=release" "QMAKE_CXXFLAGS+=-Wno-deprecated-copy"
          
          echo.
          echo Compiling with mingw32-make...
          mingw32-make -j4
          
          echo.
          echo Build completed successfully!

      - name: üì¶ Deploy Qt dependencies
        run: |
          windeployqt --release release\ScreenshotTool.exe
        working-directory: release

      - name: üíæ Package for Windows 7
        run: |
          powershell -Command "Compress-Archive -Path 'release\*' -DestinationPath 'ScreenshotTool-win32-qt5.12.12.zip' -Force"
        working-directory: .

      - name: üöÄ Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ScreenshotTool-win32-qt5.12.12
          path: ScreenshotTool-win32-qt5.12.12.zip
          retention-days: 30

      - name: ‚úÖ Success message
        if: success()
        run: |
          echo.
          echo ========================================
          echo  ‚úÖ BUILD SUCCESSFUL!
          echo  üì¶ Artifact: ScreenshotTool-win32-qt5.12.12.zip
          echo  üíª Works on Windows 7 SP1 (32/64-bit)
          echo  ‚ö†Ô∏è  Qt 5.12.12 warnings are SAFE to ignore
          echo ========================================
