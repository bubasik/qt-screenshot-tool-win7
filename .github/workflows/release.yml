name: Build Qt Screenshot Tool (64-bit)

on:
  push:
    branches: [ main ]
  pull_request:
  workflow_dispatch:

jobs:
  build-win64:
    runs-on: windows-2022

    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4

      - name: ‚öôÔ∏è Setup Qt 5.12.12 (64-bit, MinGW)
        uses: jurplel/install-qt-action@v4
        with:
          version: '5.12.12'
          arch: 'win64_mingw73'
          cache: true
          cache-key-prefix: qt-win64-mingw73-5.12.12
          set-env: true

      - name: üîç Verify toolchain
        shell: pwsh
        run: |
          Write-Host "=== Qt version ==="
          qmake --version
          
          Write-Host "`n=== Compiler architecture ==="
          $arch = g++ -dumpmachine 2>&1
          Write-Host "Architecture: $arch"
          if ($arch -notlike "*x86_64*") {
            Write-Error "‚ùå Not 64-bit compiler!"
            exit 1
          }
          Write-Host "‚úÖ 64-bit confirmed"

      - name: üõ†Ô∏è Build project (Release)
        run: |
          qmake ScreenshotTool.pro "CONFIG+=release"
          mingw32-make -j4
        shell: cmd

      - name: üîç Debug locate executable
        run: |
          echo === Searching for .exe files ===
          dir /s /b *.exe
          echo.
          echo === Current directory structure ===
          dir
        shell: cmd

      - name: üì¶ Deploy Qt dependencies (auto-detect .exe)
        shell: pwsh
        run: |
          # –ò—â–µ–º .exe –≤ —Ç–µ–∫—É—â–µ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –∏ –ø–æ–¥–ø–∞–ø–∫–∞—Ö
          $exePath = Get-ChildItem -Path . -Filter "*.exe" -Recurse | Select-Object -First 1 -ExpandProperty FullName
          
          if (-not $exePath) {
            Write-Error "‚ùå No .exe file found after build!"
            exit 1
          }
          
          Write-Host "‚úÖ Found executable: $exePath"
          Write-Host "Running windeployqt..."
          
          windeployqt --release "$exePath"
          
          # –ö–æ–ø–∏—Ä—É–µ–º .exe –≤ –æ—Ç–¥–µ–ª—å–Ω—É—é –ø–∞–ø–∫—É –¥–ª—è –∞—Ä—Ö–∏–≤–∞—Ü–∏–∏
          $deployDir = "deploy"
          New-Item -ItemType Directory -Path $deployDir -Force | Out-Null
          Copy-Item -Path "$exePath" -Destination $deployDir -Force
          
          # –ö–æ–ø–∏—Ä—É–µ–º –≤—Å–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ (dll, plugins)
          $exeDir = Split-Path $exePath -Parent
          Copy-Item -Path "$exeDir\*.dll" -Destination $deployDir -ErrorAction SilentlyContinue
          Copy-Item -Path "$exeDir\platforms" -Destination $deployDir -Recurse -ErrorAction SilentlyContinue
          Copy-Item -Path "$exeDir\imageformats" -Destination $deployDir -Recurse -ErrorAction SilentlyContinue
          
          Write-Host "‚úÖ Deployment completed in $deployDir"

      - name: üíæ Package for Windows
        run: |
          Compress-Archive -Path deploy\* -DestinationPath ScreenshotTool-win64-qt5.12.12.zip -Force
        shell: pwsh

      - name: üöÄ Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ScreenshotTool-win64-qt5.12.12
          path: ScreenshotTool-win64-qt5.12.12.zip
          retention-days: 30

      - name: ‚úÖ Success message
        if: success()
        run: |
          echo.
          echo ========================================
          echo  ‚úÖ BUILD SUCCESSFUL!
          echo  üì¶ Artifact: ScreenshotTool-win64-qt5.12.12.zip
          echo  üíª Works on Windows 7+ (64-bit)
          echo ========================================
        shell: cmd

      - name: üíæ –£–ø–∞–∫–æ–≤–∫–∞ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–æ–≤
        run: |
          $arch = "${{ matrix.arch }}"
          $zipName = "ScreenshotTool-win${arch}-qt5.12.12.zip"
          Compress-Archive -Path "release\*" -DestinationPath "..\$zipName"
          echo "ARTIFACT_PATH=../$zipName" | Out-File -FilePath $env:GITHUB_ENV -Append
        working-directory: release

      - name: üöÄ –°–æ–∑–¥–∞–Ω–∏–µ —Ä–µ–ª–∏–∑–∞ –Ω–∞ GitHub
        uses: softprops/action-gh-release@v2
        with:
          files: ${{ env.ARTIFACT_PATH }}
          tag_name: ${{ github.ref_name }}
          name: "–í–µ—Ä—Å–∏—è ${{ github.ref_name }}"
          body: |
            ‚ú® –ù–æ–≤–∞—è –≤–µ—Ä—Å–∏—è —Å–∫—Ä–∏–Ω—à–æ—Ç–µ—Ä–∞ —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π Windows 7!
            
            ## –ß—Ç–æ –Ω–æ–≤–æ–≥–æ
            - –ü–æ–ª–Ω–æ—ç–∫—Ä–∞–Ω–Ω—ã–π –∑–∞—Ö–≤–∞—Ç —ç–∫—Ä–∞–Ω–∞
            - 4 —Ç–µ–º—ã –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è: –°–≤–µ—Ç–ª–∞—è, –¢—ë–º–Ω–∞—è, –ë–∏—Ä—é–∑–æ–≤–∞—è, –ú–∞—Ç—Ä–∏—Ü–∞
            - –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ PNG/JPEG + –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞
            
            ## –°–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å
            ‚úÖ Windows 7 SP1+ (—Ç—Ä–µ–±—É—é—Ç—Å—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è KB2533623, KB2999226)
            ‚úÖ Windows 10/11
            
            ## –°–∫–∞—á–∞—Ç—å
            –í—ã–±–µ—Ä–∏—Ç–µ –∞—Ä—Ö–∏–≤ –ø–æ–¥ –≤–∞—à—É —Å–∏—Å—Ç–µ–º—É:
            - `ScreenshotTool-win32-qt5.12.12.zip` ‚Äî –¥–ª—è 32-–±–∏—Ç–Ω—ã—Ö —Å–∏—Å—Ç–µ–º (—Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–∞ –≤—Å–µ—Ö –ü–ö)
            - `ScreenshotTool-win64-qt5.12.12.zip` ‚Äî –¥–ª—è 64-–±–∏—Ç–Ω—ã—Ö —Å–∏—Å—Ç–µ–º
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
